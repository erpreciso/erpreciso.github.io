---
title: Collegare il MCU 8266 ESP-12
date: 2016-07-31 21:20 +02:00
excerpt: Come aggiornare il firmware del MCU 8266 ESP-12
lang: it
ref: esp8266
tag: elettronica

---

# Introduzione

Il modulo [MCU 8266](https://en.wikipedia.org/wiki/ESP8266){:target="_blank"} puó essere usato per collegarsi ad una rete WiFi e creare connessioni TCP/IP. In questo articolo, lo collego ad Arduino, ne aggiorno il firmware e lo collego alla mia rete domestica per verificarne il funzionamento.

# Collegamento

La versione del modulo che possiedo è [ESP-12](https://www.amazon.de/gp/product/B00WJNHOGY/ref=oh_aui_detailpage_o01_s00?ie=UTF8&amp;psc=1){:target="_blank"}; mi assicuro di ricercare i collegamenti corretti per questo modello.

Nel forum dedicato su [esp8266.com](http://www.esp8266.com/){:target="_blank"} si puó trovare una [discussione dedicata sulla white board](http://www.esp8266.com/viewtopic.php?f=13&amp;t=6505){:target="_blank"}, che contiene i corretti *pullups* per i pin `RST` e `CH_PD`, mentre `GPI015` deve essere collegato a massa.

Per rendere i segnali compatibili con i livelli di tensione sui pin di Arduino, uso un convertitore esadecimale [CD4050B](http://www.ee.washington.edu/stores/DataSheets/cd4000/cd4049.pdf){:target="_blank"}; esso converte i 5v in uscita da Arduino in 3.3v richiesti dal modulo 8266.

Ho bisogno di una sorgente di tensione che deve generare almeno 500mA a 3.3v; combino quindi un [alimentatore 12v](https://www.amazon.de/gp/product/B0056SV18Q){:target="_blank"} con un [convertitore 5v/3.3v MB102](https://www.amazon.de/Breadboard-Module-Adapter-Schild-Arduino-Board/dp/B01HN0HVY2){:target="_blank"}.

Uso una porta USB serial-to-ttl, la [CH340G](https://www.amazon.de/EasyWordMall-CH340G-Serial-Converter-Upgrade/dp/B00YHP8LP0/ref=sr_1_5?ie=UTF8&amp;qid=1468529490&amp;sr=8-5&amp;keywords=USB+to+3.3V+TTL+converter){:target="_blank"};

* Connetto `Vcc` a 3.3v e `GND` alla massa dell'alimentatore e a  quella del convertitore seriale;

* Connetto `Rx` dal seriale al `Tx` sul 8266, e `Tx` dal seriale a `Rx` del 8266; connetto `Tx` da Arduino al `pin 3` del 4050, e `pin 2` a `Rx` del 8266; alimentando il 4050 con 3.3v, converto i 5v da Arduino ai 3.3v supportati dal 8266;

* `RST` deve essere acceso: lo connetto a 3.3v tramite una resistenza da 1K. Connetto un pulsante tra il pin e massa, cosí da poter resettare facilmente quando serve;

* `GPI00` deve stare normalmente scollegato, ma lo connetto ad un pulsante per poterlo portare a massa nel momento in cui devo effettuare il flash del firmware.

![]({{ site.url }}/assets/images/esp8266/esp8266.png)


# Aggiornamento del firmware

* Scarico il firmware da [electrodragon](http://www.electrodragon.com/w/ESP8266_AT_Commands){:target="_blank"}

* Installo il tool python [esptool](https://github.com/themadinventor/esptool){:target="_blank"}, una utilitá per effettuare il flash della ROM dell'8266, utilizzando [PyPI](https://pypi.python.org/pypi/esptool){:target="_blank"}

* Connetto il convertitore seriale ad una USB, e individuo la porta assegnata dal sistema operativo (ad esempio, `COM4` in Windows, e `/dev/ttyUSB0` in Linux)

* Lancio `esptool`

```
esptool.py --port /dev/ttyUSB0 write_flash 0x00000 v1.3.0.2\ AT\ Firmware.bin
```

Per altre versioni del firmware si puó fare riferimento alla documentazione appropriata (ad esempio il firmware da **expressif** è composto da 4 files, e i quattro indirizzi di memoria sono disponibili nella [repository github](https://github.com/espressif/ESP8266_AT/blob/master/bin/readme.txt){:target="_blank"}).

L'output di `esptool` è il seguente:

![]({{ site.url }}/assets/images/esp8266/flashing-esp8266.png)

# Prova

Apro un'interfaccia seriale, [cutecom](http://freecode.com/projects/cutecom){:target="_blank"}, un'alternativa a `puTTy` per Windows, anche se la IDE di Arduino con la sua interfaccia per porta seriale sarebbe stata equivalente. Mi assicuro di regolare il baud rate a **115,200**, essendo questo il default del nuovo firmware.

Provo qualche comando base:

* Ottengo una risposta "OK":

```
AT

OK
```

* Ottengo la versione del firmware:

```
AT+GMR

AT version:0.40.0.0(Aug  8 2015 14:45:58)
SDK version:1.3.0
Ai-Thinker Technology Co.,Ltd.
Build:1.3.0.2 Sep 11 2015 11:48:04
```

* Verifico CWmode: deve essere settato a `3` per operare con WiFi

```
AT+CWMODE?

+CWMODE:2

OK
AT+CWMODE=3

OK
```

* Elenco gli access point disponibili;

```
AT+CWLAP

+CWLAP:(4,"FRITZ!Box 30 SL",-68,"9c:c7:a6:47:13",1,-37)
+CWLAP:(3,"dvolo-bcf2af753afb",-87,"bc:f2:af:75:fb",1,30)
+CWLAP:(4,"FRITZ!Box",-62,"34:81:c4:b3:58",1,-14)
+CWLAP:(4,"UPC573552",-92,"b0:c2:87:82:e9:",1,-24)
+CWLAP:(4,"Funklch",-76,"5c:dc:96:1:31:c8",4,-22)
+CWLAP:(3,"WLAN-60352",-70,":21:22:2a:8a:13",11,-54)
+CWLAP:(4,"Chrisilan",-85,"24:65:1:0a:83:fe",11,-29)
+CWLAP:(4,"FRITZ!Box Fon WLAN 790",-89,"9c:c7:a6:f4:22:8c",11,-27)
```

* Collego ad un access point mediante UUID e password:

```
AT+CWJAP="FRITZ!Box","992815669545102078"

WIFI CONNECTED
WIFI GOT IP

OK
```

# Risorse

* Tutorial per aggiornare firmware da [esp8266.com](http://www.esp8266.com/wiki/doku.php?id=loading_firmware){:target="_blank"}
* Tutorial per aggiornare firmware da [medium.com](https://medium.com/@nowir3s/getting-started-with-esp8266-875fb54441d6#.cfy9gegin){:target="_blank}
* aI Thinker AT [firmware](http://www.electrodragon.com/w/ESP8266_AT_Commands){:target="_blank"}
* Forum espressif: [versione piú recente di SDK](http://www.espressif.com/en/support/download/sdks-demos){:target="_blank"} e [documentazione](http://www.espressif.com/en/support/download/documents){:target="_blank"}
* Pagina github di espressif: [firmware](https://github.com/espressif/ESP8266_AT){:target="_blank"}, e [indirizzi di memoria per ogni pin](https://github.com/espressif/ESP8266_AT/blob/master/bin/readme.txt){:target="_blank"}
* Lista comandi AT dalla [documentazione espressif](http://espressif.com/sites/default/files/documentation/4a-esp8266_at_instruction_set_en.pdf){:target="_blank"}
* Altre informazioni utili sul 8266 da [nurdspace](https://nurdspace.nl/ESP8266){:target="_blank"}
* [codice sorgente di espressif](https://github.com/espressif/esp8266_at/blob/master/at/user/at_cmd.h#L34){:target="_blank"}, dove si puó notare la lista di comandi AT
